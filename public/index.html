<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Demuno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Special+Elite&display=swap');

        body {
            background-color: #050505;
            color: #e2e2e2;
            font-family: 'Special Elite', cursive;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            background: radial-gradient(circle, #1a0505 0%, #050505 100%);
            display: flex;
            flex-direction: column;
        }

        .horror-title {
            font-family: 'Creepster', cursive;
            text-shadow: 0 0 10px #ff0000;
        }

        /* Branding Style */
        .branding-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-5deg);
            font-family: 'Creepster', cursive;
            font-size: 3rem;
            color: #600; /* Etwas helleres Blutrot fÃ¼r bessere Lesbarkeit */
            opacity: 0.25;
            pointer-events: none;
            text-shadow: 2px 2px 4px #000;
            width: 100%;
            text-align: center;
            z-index: 0;
            white-space: nowrap;
        }
        
        @media (max-width: 600px) {
            .branding-watermark { 
                font-size: 1.2rem; 
                white-space: normal; /* Umbruch auf kleinen Handys erlauben */
                line-height: 1.2;
                padding: 0 20px;
            } 
        }

        .card {
            width: 60px;
            height: 90px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 4px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            user-select: none;
            background-size: cover;
            flex-shrink: 0;
            pointer-events: auto;
            touch-action: manipulation;
        }

        @media (min-height: 700px) {
            .card { width: 70px; height: 105px; }
        }

        .card:hover {
            transform: translateY(-10px) scale(1.1);
            z-index: 100;
            box-shadow: 0 0 15px #ff0000;
        }

        .card-red { background: linear-gradient(135deg, #660000, #330000); color: #ffcccc; }
        .card-blue { background: linear-gradient(135deg, #001a33, #000d1a); color: #cce6ff; }
        .card-green { background: linear-gradient(135deg, #0d3300, #061a00); color: #e6ffcc; }
        .card-yellow { background: linear-gradient(135deg, #4d3d00, #261e00); color: #fffacc; }
        .card-black { background: linear-gradient(135deg, #111, #000); color: #ff0000; border: 1px solid #444; }

        .card-back {
            background: #111;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ghost-svg {
            width: 70%;
            height: 70%;
            fill: #440000;
            filter: drop-shadow(0 0 5px #ff0000);
        }

        .active-player {
            outline: 2px solid #ff0000;
            box-shadow: 0 0 15px #ff0000;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 8px;
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 150px #000;
            pointer-events: none;
            z-index: 50; 
        }

        .player-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 2px 6px;
            background: rgba(0,0,0,0.7);
        }

        #my-hand {
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 100vw;
            padding: 0 10px;
            position: relative;
            z-index: 100;
            pointer-events: auto;
        }

        #my-hand .card {
            margin-left: -25px;
        }

        #my-hand .card:first-child {
            margin-left: 0;
        }
        
        #draw-pile {
            z-index: 60;
            position: relative;
        }

        #login-screen {
            background: rgba(0,0,0,0.95);
            z-index: 500;
        }
        
        input {
            background: #111;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            font-family: 'Special Elite';
            text-align: center;
        }
        
        input:focus {
            outline: none;
            border-color: #800;
        }

        /* --- CHAT STYLES (TOP RIGHT) --- */
        #chat-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 400; 
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            pointer-events: auto;
        }

        #chat-btn {
            background: #220000;
            border: 1px solid #600;
            color: #f88;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 0 10px #000;
            transition: all 0.2s;
        }
        
        #chat-btn:active {
            transform: scale(0.9);
        }

        #chat-window {
            width: 280px;
            height: 300px;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #600;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none; 
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 0 20px #000;
        }
        
        #chat-header {
            background: #200;
            padding: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #600;
            font-size: 14px;
            color: #f88;
            font-weight: bold;
        }
        
        #chat-close-btn {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #500;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 18px;
        }
        
        #chat-close-btn:active {
            background: #f00;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 8px;
            font-size: 12px;
            color: #ccc;
        }

        #chat-input-area {
            display: flex;
            border-top: 1px solid #333;
            height: 40px;
        }

        #chat-input {
            flex-grow: 1;
            background: #111;
            border: none;
            color: white;
            padding: 8px;
            font-size: 14px;
            text-align: left;
        }

        #chat-send {
            background: #400;
            color: white;
            border: none;
            padding: 0 15px;
            font-size: 16px;
            cursor: pointer;
        }

        .chat-msg { margin-bottom: 4px; word-break: break-word; }
        .chat-name { color: #f44; font-weight: bold; margin-right: 4px; }
        .chat-text { color: #ddd; }
        
        .new-msg-anim {
            animation: pulse-red 1s infinite;
        }
        
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
    </style>
</head>
<body class="py-2">

    <div class="vignette"></div>
    
    <!-- BRANDING -->
    <div class="branding-watermark">R & D Hirscher Entertainment</div>

    <!-- Login / Lobby -->
    <div id="login-screen" class="fixed inset-0 flex flex-col items-center justify-center">
        <h1 class="horror-title text-5xl mb-8 text-red-600">DEMUNO</h1>
        
        <div id="join-form" class="flex flex-col gap-4 w-64">
            <input type="text" id="player-name" placeholder="Dein Name" maxlength="10">
            <input type="text" id="room-id" placeholder="Raum Code (z.B. 666)" value="666">
            <button onclick="joinGame()" class="px-6 py-2 bg-red-900 text-white rounded hover:bg-red-800 transition">Beitreten</button>
        </div>

        <div id="lobby-wait" class="hidden flex flex-col items-center gap-4">
            <p class="text-xl">Warte in der Dunkelheit...</p>
            <div id="player-list" class="text-red-400"></div>
            
            <button id="start-btn" onclick="startGame()" class="hidden px-6 py-2 bg-green-900 text-white rounded mt-4 border border-green-700 hover:bg-green-800">NACHT BEGINNEN</button>
            
            <p id="wait-msg" class="text-xs text-gray-500 mt-2">Warte auf Host...</p>
        </div>
    </div>

    <!-- Game Area -->
    <div id="game-ui" class="hidden flex-col h-full w-full">
        
        <!-- Opponents Area (Dynamic) -->
        <div id="opponents-container" class="flex flex-wrap justify-around items-start flex-grow p-2 gap-2" style="z-index: 60;">
        </div>

        <!-- Center: Table -->
        <div class="flex flex-col items-center gap-4 z-20 my-4" style="z-index: 60; position: relative;">
            <div class="flex items-center gap-6 md:gap-10">
                <div id="draw-pile" class="card card-back shadow-2xl relative cursor-pointer" onclick="drawCard()">
                    <svg class="ghost-svg" viewBox="0 0 24 24"><path d="M12 2c-4.418 0-8 3.582-8 8v10c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552.448-1 1-1s1 .448 1 1v1c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552.448-1 1-1s1 .448 1 1v1c0 .552.448 1 1 1s1-.448 1-1v-10c0-4.418-3.582-8-8-8zm-3 9c-.552 0-1-.448-1-1s.448-1 1-1 1 .448 1 1-.448 1-1 1zm6 0c-.552 0-1-.448-1-1s.448-1 1-1 1 .448 1 1-.448 1-1 1z"/></svg>
                </div>

                <div id="discard-pile" class="relative"></div>
            </div>

            <div id="status-display" class="text-[12px] md:text-sm text-red-400 italic text-center h-4 min-w-[200px] z-50">Lade...</div>
        </div>

        <!-- Bottom: Real Player -->
        <div id="my-area" class="flex flex-col items-center gap-1 transition-all duration-300 pb-4 relative z-50">
            <span class="player-label text-white bg-black/40 rounded border border-gray-800">Du</span>
            <div id="my-hand" class="relative"></div>
        </div>
    </div>

    <!-- CHAT UI (Fixed Position Top Right) -->
    <div id="chat-container" class="hidden">
        <div id="chat-window">
            <div id="chat-header">
                <span>Dunkler Chat</span>
                <button id="chat-close-btn" onclick="toggleChat()" type="button">âœ•</button>
            </div>
            <div id="chat-messages">
                <div class="text-gray-500 italic">Chatraum geÃ¶ffnet...</div>
            </div>
            <div id="chat-input-area">
                <input type="text" id="chat-input" placeholder="Nachricht..." onkeypress="handleChatEnter(event)">
                <button id="chat-send" onclick="sendChat()">âž¤</button>
            </div>
        </div>
        <button id="chat-btn" onclick="toggleChat()">ðŸ’¬</button>
    </div>

    <!-- Modals -->
    <div id="color-modal" class="fixed inset-0 flex items-center justify-center z-[200] hidden bg-black/90">
        <div class="p-6 rounded border border-red-900 text-center bg-black">
            <h2 class="horror-title text-xl mb-6">Farbe wÃ¤hlen</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="submitColor('red')" class="w-12 h-12 bg-red-800 border-2 border-red-500 hover:scale-110 transition"></button>
                <button onclick="submitColor('blue')" class="w-12 h-12 bg-blue-800 border-2 border-blue-500 hover:scale-110 transition"></button>
                <button onclick="submitColor('green')" class="w-12 h-12 bg-green-800 border-2 border-green-500 hover:scale-110 transition"></button>
                <button onclick="submitColor('yellow')" class="w-12 h-12 bg-yellow-800 border-2 border-yellow-500 hover:scale-110 transition"></button>
            </div>
        </div>
    </div>

    <div id="game-over" class="fixed inset-0 flex items-center justify-center z-[300] hidden bg-black">
        <div class="text-center p-8">
            <h1 id="go-title" class="horror-title text-4xl mb-4 text-red-600">ERLÃ–ST</h1>
            <p id="go-msg" class="mb-8 text-sm">Du hast die Schatten besiegt.</p>
            <button onclick="location.reload()" class="px-6 py-2 bg-red-900 text-white rounded hover:bg-red-700">Neu starten</button>
        </div>
    </div>

    <script>
        const socket = io({
            transports: ['websocket'], 
            upgrade: false
        });
        
        const SYMBOLS = {'Jump Scare': 'ðŸ˜±', 'Ritual': 'ðŸ”„', 'Blutpakt': '++'};
        
        let myRoomId = '';
        let pendingCardIndex = null; 
        let chatOpen = false;

        function joinGame() {
            const name = document.getElementById('player-name').value;
            myRoomId = document.getElementById('room-id').value;
            if(!name || !myRoomId) return alert("Name und Raum Code erforderlich.");

            socket.emit('joinGame', { name, roomId: myRoomId });
        }

        socket.on('lobbyUpdate', (data) => {
            document.getElementById('join-form').classList.add('hidden');
            document.getElementById('lobby-wait').classList.remove('hidden');
            document.getElementById('lobby-wait').classList.add('flex');
            
            const list = document.getElementById('player-list');
            list.innerHTML = data.players.map(p => `<div>ðŸ‘» ${p}</div>`).join('');

            const iAmHost = socket.id === data.hostId;
            const startBtn = document.getElementById('start-btn');
            const waitMsg = document.getElementById('wait-msg');

            if(iAmHost) {
                if(data.canStart) {
                    startBtn.classList.remove('hidden');
                    waitMsg.innerText = "Bereit zum Starten...";
                } else {
                    startBtn.classList.add('hidden');
                    waitMsg.innerText = "Warte auf Mitspieler...";
                }
            } else {
                startBtn.classList.add('hidden');
                waitMsg.innerText = `Warte auf ${data.hostName} zum Starten...`;
            }
        });

        socket.on('error', (msg) => alert(msg));
        
        function startGame() {
            socket.emit('startGame', { roomId: myRoomId });
        }

        socket.on('gameState', (state) => {
            if(!state.gameActive && !document.getElementById('game-over').classList.contains('hidden')) return; 
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('game-ui').classList.add('flex');
            
            // Chat anzeigen sobald Spiel startet
            document.getElementById('chat-container').classList.remove('hidden');

            renderMyHand(state.hand, state.isMyTurn);
            renderOpponents(state.opponents);
            renderDiscardPile(state.topCard, state.activeColor);
            updateStatus(state.status);
            
            const myArea = document.getElementById('my-area');
            if(state.isMyTurn) myArea.classList.add('active-player');
            else myArea.classList.remove('active-player');

            if(!state.gameActive && state.status.includes('ERLÃ–ST')) {
                showGameOver(state.status);
            }
        });

        socket.on('playerLeft', (msg) => {
            alert(msg);
            location.reload();
        });

        // --- CHAT FUNCTIONS FIXED ---
        function toggleChat() {
            const win = document.getElementById('chat-window');
            const btn = document.getElementById('chat-btn');
            
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                win.style.display = 'flex';
                btn.style.display = 'none';
                btn.classList.remove('new-msg-anim');
                
                setTimeout(() => document.getElementById('chat-input').focus(), 50);
            } else {
                win.style.display = 'none';
                btn.style.display = 'flex';
            }
        }

        function handleChatEnter(e) {
            if (e.key === 'Enter') sendChat();
        }

        function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if (msg.trim()) {
                socket.emit('chatMessage', { roomId: myRoomId, message: msg });
                input.value = '';
            }
        }

        socket.on('chatMessage', (data) => {
            const chatBox = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-msg';
            div.innerHTML = `<span class="chat-name">${data.name}:</span><span class="chat-text">${escapeHtml(data.text)}</span>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;

            if (!chatOpen) {
                document.getElementById('chat-btn').classList.add('new-msg-anim');
            }
        });

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- RENDER FUNCTIONS ---
        function renderMyHand(hand, isMyTurn) {
            const handEl = document.getElementById('my-hand');
            handEl.innerHTML = '';
            
            hand.forEach((card, idx) => {
                const cardEl = createCardUI(card);
                if(isMyTurn) {
                    cardEl.style.cursor = 'pointer';
                    cardEl.onclick = (e) => {
                        e.stopPropagation();
                        tryPlayCard(idx, card);
                    };
                } else {
                    cardEl.style.opacity = '0.7';
                    cardEl.style.cursor = 'not-allowed';
                }
                handEl.appendChild(cardEl);
            });
        }

        function renderOpponents(opponents) {
            const container = document.getElementById('opponents-container');
            container.innerHTML = '';

            opponents.forEach(op => {
                const opDiv = document.createElement('div');
                opDiv.className = `flex flex-col items-center gap-1 transition-all duration-300 ${op.isTurn ? 'active-player' : 'opacity-60'}`;
                
                const cardStack = document.createElement('div');
                cardStack.className = 'flex -space-x-10 scale-75 md:scale-90 mt-2';
                
                const visualCount = Math.min(op.cardCount, 5);
                for(let i=0; i<visualCount; i++) {
                    cardStack.appendChild(createCardUI(null, true));
                }
                if(op.cardCount > 5) {
                    const extra = document.createElement('div');
                    extra.className = 'text-xs text-red-500 font-bold ml-2 self-center';
                    extra.innerText = `+${op.cardCount - 5}`;
                    cardStack.appendChild(extra);
                }

                const label = document.createElement('span');
                label.className = 'player-label text-red-500';
                label.innerText = op.name + ` (${op.cardCount})`;

                opDiv.appendChild(cardStack);
                opDiv.appendChild(label);
                container.appendChild(opDiv);
            });
        }

        function renderDiscardPile(card, activeColor) {
            const discardEl = document.getElementById('discard-pile');
            discardEl.innerHTML = '';
            if(!card) return;

            const cardEl = createCardUI(card);
            
            if (card.color === 'black') {
                const dot = document.createElement('div');
                const colorMap = { 'red': '#991b1b', 'blue': '#1e3a8a', 'green': '#14532d', 'yellow': '#ca8a04' };
                dot.className = `absolute -top-1 -right-1 w-4 h-4 rounded-full border border-white z-50`;
                dot.style.backgroundColor = colorMap[activeColor] || activeColor;
                dot.style.boxShadow = `0 0 10px ${colorMap[activeColor]}`;
                cardEl.appendChild(dot);
            }
            discardEl.appendChild(cardEl);
        }

        function tryPlayCard(idx, card) {
            if(card.color === 'black') {
                pendingCardIndex = idx;
                document.getElementById('color-modal').classList.remove('hidden');
            } else {
                emitPlay(idx, null);
            }
        }

        function submitColor(color) {
            document.getElementById('color-modal').classList.add('hidden');
            if(pendingCardIndex !== null) {
                emitPlay(pendingCardIndex, color);
                pendingCardIndex = null;
            }
        }

        function emitPlay(idx, color) {
            socket.emit('playCard', {
                roomId: myRoomId,
                cardIndex: idx,
                color: color
            });
        }

        function drawCard() {
            socket.emit('drawCard', { roomId: myRoomId });
        }

        function updateStatus(msg) {
            document.getElementById('status-display').innerText = msg;
        }

        function showGameOver(msg) {
            document.getElementById('game-over').classList.remove('hidden');
            document.getElementById('go-msg').innerText = msg;
        }

        function createCardUI(card, hidden = false) {
            const div = document.createElement('div');
            if (hidden) {
                div.className = 'card card-back';
                div.innerHTML = `<svg class="ghost-svg" viewBox="0 0 24 24"><path d="M12 2c-4.418 0-8 3.582-8 8v10c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552.448-1 1-1s1 .448 1 1v1c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552.448-1 1-1s1 .448 1 1v1c0 .552.448 1 1 1s1-.448 1-1v-10c0-4.418-3.582-8-8-8zm-3 9c-.552 0-1-.448-1-1s.448-1 1-1 1 .448 1 1-.448 1-1 1zm6 0c-.552 0-1-.448-1-1s.448-1 1-1 1 .448 1 1-.448 1-1 1z"/></svg>`;
                return div;
            }
            
            div.className = `card card-${card.color}`;
            const display = SYMBOLS[card.value] || card.value;
            div.innerHTML = `
                <span class="text-[6px] self-start">${card.value}</span>
                <span class="text-lg">${display === 'Dunkler Pakt' ? 'ðŸ’€' : (display === 'Wahl' ? 'âœ¨' : display)}</span>
                <span class="text-[6px] self-end rotate-180">${card.value}</span>
            `;
            return div;
        }
    </script>
</body>
</html>


