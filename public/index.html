<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Demuno</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Special+Elite&display=swap');

        body {
            background-color: #050505;
            color: #e2e2e2;
            font-family: 'Special Elite', cursive;
            overflow: hidden;
            height: 100vh;
            margin: 0;
            background: radial-gradient(circle, #1a0505 0%, #050505 100%);
            display: flex;
            flex-direction: column;
        }

        .horror-title {
            font-family: 'Creepster', cursive;
            text-shadow: 0 0 10px #ff0000;
        }

        .card {
            width: 60px;
            height: 90px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 4px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.1);
            user-select: none;
            background-size: cover;
            flex-shrink: 0;
        }

        @media (min-height: 700px) {
            .card { width: 70px; height: 105px; }
        }

        .card:hover {
            transform: translateY(-10px) scale(1.1);
            z-index: 100;
            box-shadow: 0 0 15px #ff0000;
        }

        .card-red { background: linear-gradient(135deg, #660000, #330000); color: #ffcccc; }
        .card-blue { background: linear-gradient(135deg, #001a33, #000d1a); color: #cce6ff; }
        .card-green { background: linear-gradient(135deg, #0d3300, #061a00); color: #e6ffcc; }
        .card-yellow { background: linear-gradient(135deg, #4d3d00, #261e00); color: #fffacc; }
        .card-black { background: linear-gradient(135deg, #111, #000); color: #ff0000; border: 1px solid #444; }

        .card-back {
            background: #111;
            border: 2px solid #333;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ghost-svg {
            width: 70%;
            height: 70%;
            fill: #440000;
            filter: drop-shadow(0 0 5px #ff0000);
        }

        .active-player {
            outline: 2px solid #ff0000;
            box-shadow: 0 0 15px #ff0000;
            background: rgba(255, 0, 0, 0.1);
            border-radius: 8px;
        }

        .vignette {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 150px #000;
            pointer-events: none;
            z-index: 50;
        }

        .player-label {
            font-size: 0.6rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 2px 6px;
            background: rgba(0,0,0,0.7);
        }

        #my-hand {
            display: flex;
            justify-content: center;
            width: 100%;
            max-width: 100vw;
            padding: 0 10px;
        }

        #my-hand .card {
            margin-left: -25px;
        }

        #my-hand .card:first-child {
            margin-left: 0;
        }

        /* Lobby Styles */
        #login-screen {
            background: rgba(0,0,0,0.95);
            z-index: 500;
        }
        
        input {
            background: #111;
            border: 1px solid #444;
            color: white;
            padding: 8px;
            font-family: 'Special Elite';
            text-align: center;
        }
        
        input:focus {
            outline: none;
            border-color: #800;
        }
    </style>
</head>
<body class="py-2">

    <div class="vignette"></div>

    <!-- Login / Lobby -->
    <div id="login-screen" class="fixed inset-0 flex flex-col items-center justify-center">
        <h1 class="horror-title text-5xl mb-8 text-red-600">DEMUNO</h1>
        
        <div id="join-form" class="flex flex-col gap-4 w-64">
            <input type="text" id="player-name" placeholder="Dein Name" maxlength="10">
            <input type="text" id="room-id" placeholder="Raum Code (z.B. 666)" value="666">
            <button onclick="joinGame()" class="px-6 py-2 bg-red-900 text-white rounded hover:bg-red-800 transition">Beitreten</button>
        </div>

        <div id="lobby-wait" class="hidden flex flex-col items-center gap-4">
            <p class="text-xl">Warte in der Dunkelheit...</p>
            <div id="player-list" class="text-red-400"></div>
            
            <!-- HIER WURDE GEÃ„NDERT: Button ist standardmÃ¤ÃŸig versteckt -->
            <button id="start-btn" onclick="startGame()" class="hidden px-6 py-2 bg-green-900 text-white rounded mt-4 border border-green-700 hover:bg-green-800">NACHT BEGINNEN</button>
            
            <p id="wait-msg" class="text-xs text-gray-500 mt-2">Warte auf Host...</p>
        </div>
    </div>

    <!-- Game Area -->
    <div id="game-ui" class="hidden flex-col h-full w-full">
        
        <!-- Opponents Area (Dynamic) -->
        <div id="opponents-container" class="flex flex-wrap justify-around items-start flex-grow p-2 gap-2">
            <!-- Opponents will be injected here via JS -->
        </div>

        <!-- Center: Table -->
        <div class="flex flex-col items-center gap-4 z-20 my-4">
            <div class="flex items-center gap-6 md:gap-10">
                <div id="draw-pile" class="card card-back shadow-2xl relative cursor-pointer" onclick="drawCard()">
                    <svg class="ghost-svg" viewBox="0 0 24 24"><path d="M12 2c-4.418 0-8 3.582-8 8v10c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552.448-1 1-1s1 .448 1 1v1c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552.448-1 1-1s1 .448 1 1v1c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552.448-1 1-1s1 .448 1 1v1c0 .552.448 1 1 1s1-.448 1-1v-10c0-4.418-3.582-8-8-8zm-3 9c-.552 0-1-.448-1-1s.448-1 1-1 1 .448 1 1-.448 1-1 1zm6 0c-.552 0-1-.448-1-1s.448-1 1-1 1 .448 1 1-.448 1-1 1z"/></svg>
                </div>

                <div id="discard-pile" class="relative"></div>
            </div>

            <div id="status-display" class="text-[12px] md:text-sm text-red-400 italic text-center h-4 min-w-[200px]">Lade...</div>
            
            <button id="voice-btn" onclick="toggleVoice()" class="opacity-30 px-4 py-1 bg-red-900 border border-red-500 text-white rounded-full text-[10px] font-bold transition-all">"DEMUNO" RUFEN</button>
        </div>

        <!-- Bottom: Real Player -->
        <div id="my-area" class="flex flex-col items-center gap-1 transition-all duration-300 pb-4">
            <span class="player-label text-white bg-black/40 rounded border border-gray-800">Du</span>
            <div id="my-hand" class="relative"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="color-modal" class="fixed inset-0 flex items-center justify-center z-[200] hidden bg-black/90">
        <div class="p-6 rounded border border-red-900 text-center bg-black">
            <h2 class="horror-title text-xl mb-6">Farbe wÃ¤hlen</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="submitColor('red')" class="w-12 h-12 bg-red-800 border-2 border-red-500 hover:scale-110 transition"></button>
                <button onclick="submitColor('blue')" class="w-12 h-12 bg-blue-800 border-2 border-blue-500 hover:scale-110 transition"></button>
                <button onclick="submitColor('green')" class="w-12 h-12 bg-green-800 border-2 border-green-500 hover:scale-110 transition"></button>
                <button onclick="submitColor('yellow')" class="w-12 h-12 bg-yellow-800 border-2 border-yellow-500 hover:scale-110 transition"></button>
            </div>
        </div>
    </div>

    <div id="game-over" class="fixed inset-0 flex items-center justify-center z-[300] hidden bg-black">
        <div class="text-center p-8">
            <h1 id="go-title" class="horror-title text-4xl mb-4 text-red-600">ERLÃ–ST</h1>
            <p id="go-msg" class="mb-8 text-sm">Du hast die Schatten besiegt.</p>
            <button onclick="location.reload()" class="px-6 py-2 bg-red-900 text-white rounded hover:bg-red-700">Neu starten</button>
        </div>
    </div>

    <script>
        const socket = io();
        const SYMBOLS = {'Jump Scare': 'ðŸ˜±', 'Ritual': 'ðŸ”„', 'Blutpakt': '++'};
        
        let myRoomId = '';
        let pendingCardIndex = null; 
        let voiceActive = false;

        // --- Connection / Lobby ---
        function joinGame() {
            const name = document.getElementById('player-name').value;
            myRoomId = document.getElementById('room-id').value;
            if(!name || !myRoomId) return alert("Name und Raum Code erforderlich.");

            socket.emit('joinGame', { name, roomId: myRoomId });
        }

        socket.on('lobbyUpdate', (data) => {
            document.getElementById('join-form').classList.add('hidden');
            document.getElementById('lobby-wait').classList.remove('hidden');
            document.getElementById('lobby-wait').classList.add('flex');
            
            const list = document.getElementById('player-list');
            list.innerHTML = data.players.map(p => `<div>ðŸ‘» ${p}</div>`).join('');

            // LOGIK FIX: Client prÃ¼ft jetzt selbst, ob er der Host ist
            const iAmHost = socket.id === data.hostId;
            
            const startBtn = document.getElementById('start-btn');
            const waitMsg = document.getElementById('wait-msg');

            if(iAmHost && data.canStart) {
                startBtn.classList.remove('hidden');
                waitMsg.innerText = "Bereit zum Starten...";
            } else if (iAmHost && !data.canStart) {
                startBtn.classList.add('hidden');
                waitMsg.innerText = "Warte auf mehr Spieler (min 2)...";
            } else {
                startBtn.classList.add('hidden');
                waitMsg.innerText = "Warte auf Host...";
            }
        });

        socket.on('error', (msg) => alert(msg));
        
        function startGame() {
            socket.emit('startGame', { roomId: myRoomId });
        }

        // --- Game Logic ---

        socket.on('gameState', (state) => {
            if(!state.gameActive && !document.getElementById('game-over').classList.contains('hidden')) return; 
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('game-ui').classList.remove('hidden');
            document.getElementById('game-ui').classList.add('flex');

            renderMyHand(state.hand, state.isMyTurn);
            renderOpponents(state.opponents);
            renderDiscardPile(state.topCard, state.activeColor);
            updateStatus(state.status);
            
            const myArea = document.getElementById('my-area');
            if(state.isMyTurn) myArea.classList.add('active-player');
            else myArea.classList.remove('active-player');

            if(!state.isMyTurn) {
                voiceActive = false;
                updateVoiceBtn();
            }

            if(!state.gameActive && state.status.includes('ERLÃ–ST')) {
                showGameOver(state.status);
            }
        });

        socket.on('playerLeft', (msg) => {
            alert(msg);
            location.reload();
        });

        function renderMyHand(hand, isMyTurn) {
            const handEl = document.getElementById('my-hand');
            handEl.innerHTML = '';
            
            hand.forEach((card, idx) => {
                const cardEl = createCardUI(card);
                if(isMyTurn) {
                    cardEl.onclick = () => tryPlayCard(idx, card);
                } else {
                    cardEl.style.opacity = '0.7';
                }
                handEl.appendChild(cardEl);
            });
        }

        function renderOpponents(opponents) {
            const container = document.getElementById('opponents-container');
            container.innerHTML = '';

            opponents.forEach(op => {
                const opDiv = document.createElement('div');
                opDiv.className = `flex flex-col items-center gap-1 transition-all duration-300 ${op.isTurn ? 'active-player' : 'opacity-60'}`;
                
                const cardStack = document.createElement('div');
                cardStack.className = 'flex -space-x-10 scale-75 md:scale-90 mt-2';
                
                const visualCount = Math.min(op.cardCount, 5);
                for(let i=0; i<visualCount; i++) {
                    cardStack.appendChild(createCardUI(null, true));
                }
                if(op.cardCount > 5) {
                    const extra = document.createElement('div');
                    extra.className = 'text-xs text-red-500 font-bold ml-2 self-center';
                    extra.innerText = `+${op.cardCount - 5}`;
                    cardStack.appendChild(extra);
                }

                const label = document.createElement('span');
                label.className = 'player-label text-red-500';
                label.innerText = op.name + ` (${op.cardCount})`;

                opDiv.appendChild(cardStack);
                opDiv.appendChild(label);
                container.appendChild(opDiv);
            });
        }

        function renderDiscardPile(card, activeColor) {
            const discardEl = document.getElementById('discard-pile');
            discardEl.innerHTML = '';
            if(!card) return;

            const cardEl = createCardUI(card);
            
            if (card.color === 'black') {
                const dot = document.createElement('div');
                const colorMap = { 'red': '#991b1b', 'blue': '#1e3a8a', 'green': '#14532d', 'yellow': '#ca8a04' };
                dot.className = `absolute -top-1 -right-1 w-4 h-4 rounded-full border border-white z-50`;
                dot.style.backgroundColor = colorMap[activeColor] || activeColor;
                dot.style.boxShadow = `0 0 10px ${colorMap[activeColor]}`;
                cardEl.appendChild(dot);
            }
            discardEl.appendChild(cardEl);
        }

        function tryPlayCard(idx, card) {
            if(card.color === 'black') {
                pendingCardIndex = idx;
                document.getElementById('color-modal').classList.remove('hidden');
            } else {
                emitPlay(idx, null);
            }
        }

        function submitColor(color) {
            document.getElementById('color-modal').classList.add('hidden');
            if(pendingCardIndex !== null) {
                emitPlay(pendingCardIndex, color);
                pendingCardIndex = null;
            }
        }

        function emitPlay(idx, color) {
            socket.emit('playCard', {
                roomId: myRoomId,
                cardIndex: idx,
                color: color,
                voice: voiceActive
            });
            voiceActive = false;
            updateVoiceBtn();
        }

        function drawCard() {
            socket.emit('drawCard', { roomId: myRoomId });
        }

        function toggleVoice() {
            voiceActive = !voiceActive;
            updateVoiceBtn();
        }

        function updateVoiceBtn() {
            const btn = document.getElementById('voice-btn');
            if(voiceActive) {
                btn.classList.remove('opacity-30');
                btn.classList.add('animate-pulse', 'bg-red-600');
            } else {
                btn.classList.add('opacity-30');
                btn.classList.remove('animate-pulse', 'bg-red-600');
            }
        }

        function updateStatus(msg) {
            document.getElementById('status-display').innerText = msg;
        }

        function showGameOver(msg) {
            document.getElementById('game-over').classList.remove('hidden');
            document.getElementById('go-msg').innerText = msg;
        }

        function createCardUI(card, hidden = false) {
            const div = document.createElement('div');
            if (hidden) {
                div.className = 'card card-back';
                div.innerHTML = `<svg class="ghost-svg" viewBox="0 0 24 24"><path d="M12 2c-4.418 0-8 3.582-8 8v10c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552.448-1 1-1s1 .448 1 1v1c0 .552.448 1 1 1s1-.448 1-1v-1c0-.552.448-1 1-1s1 .448 1 1v1c0 .552.448 1 1 1s1-.448 1-1v-10c0-4.418-3.582-8-8-8zm-3 9c-.552 0-1-.448-1-1s.448-1 1-1 1 .448 1 1-.448 1-1 1zm6 0c-.552 0-1-.448-1-1s.448-1 1-1 1 .448 1 1-.448 1-1 1z"/></svg>`;
                return div;
            }
            
            div.className = `card card-${card.color}`;
            const display = SYMBOLS[card.value] || card.value;
            div.innerHTML = `
                <span class="text-[6px] self-start">${card.value}</span>
                <span class="text-lg">${display === 'Dunkler Pakt' ? 'ðŸ’€' : (display === 'Wahl' ? 'âœ¨' : display)}</span>
                <span class="text-[6px] self-end rotate-180">${card.value}</span>
            `;
            return div;
        }
    </script>
</body>
</html>


